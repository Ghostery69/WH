<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhisperWave | Ultimate Lab</title>
    <meta property="og:title" content="WhisperWave | Ultimate Lab">
    <meta property="og:description" content="Envoie-moi des messages anonymes sur WhisperWave ! ðŸ¤«">
    <meta property="og:image" content="https://api.dicebear.com/7.x/avataaars/svg?seed=WhisperWave">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { 
            --primary: #ff3e60; 
            --bg: #0b0b0b; 
            --card: #1c1c1e; 
            --text: #ffffff; 
            --text-dim: rgba(255,255,255,0.4);
            --accent: #00ff88; 
            --shadow: 0 10px 40px rgba(0,0,0,0.6); 
            --input-bg: #2c2c2e;
            --border: rgba(255,255,255,0.05);
        }

        body.light-mode {
            --bg: #f2f2f7;
            --card: #ffffff;
            --text: #1c1c1e;
            --text-dim: rgba(0,0,0,0.5);
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --input-bg: #e5e5ea;
            --border: rgba(0,0,0,0.05);
        }

        body.theme-royal { --primary: #7000ff; }
        body.theme-sunset { --primary: #ff8c00; }
        body.theme-emerald { --primary: #00c853; }
        
        body.theme-royal:not(.light-mode) { --bg: #0d011a; }
        body.theme-sunset:not(.light-mode) { --bg: #1a0f00; }
        body.theme-emerald:not(.light-mode) { --bg: #001207; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; transition: background 0.3s, color 0.3s, transform 0.2s; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
        
        #main-loader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 3px solid rgba(128,128,128,0.2); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .container { width: 100%; max-width: 420px; margin: auto; padding: 20px; padding-bottom: 100px; }
        .hidden { display: none !important; }

        .ngl-card { background: var(--card); border-radius: 30px; padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 20px; }
        .btn-ngl { width: 100%; padding: 18px; border-radius: 22px; border: none; font-weight: 800; cursor: pointer; background: var(--primary); color: white; font-size: 15px; letter-spacing: 0.5px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .btn-ngl:active { transform: scale(0.97); }

        .delirium-group { display: grid; grid-template-columns: 1.5fr 1fr; gap: 10px; margin-bottom: 30px; }
        .btn-delirium { background: var(--primary); color: white; border-radius: 20px; border: none; font-weight: 800; padding: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; text-transform: uppercase; }
        .btn-delirium.outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        .home-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
        .profile-pill { display: flex; align-items: center; gap: 12px; background: var(--card); padding: 8px 15px; border-radius: 50px; border: 1px solid var(--border); }
        .settings-circle { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; background: var(--card); border-radius: 50%; cursor: pointer; border: 1px solid var(--border); position: relative; }
        
        /* Badge Notification */
        .notif-badge { position: absolute; top: 0; right: 0; width: 14px; height: 14px; background: #ff4444; border-radius: 50%; border: 2px solid var(--bg); display: none; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .share-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; }
        .share-btn { height: 50px; border-radius: 18px; border: none; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; cursor: pointer; }
        .wa { background: #25D366; } .fb { background: #1877F2; } .sn { background: #FFFC00; color: #000; }

        .history-section { margin-top: 30px; }
        .history-label { font-size: 11px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; padding-left: 10px; }
        .msg-bubble { background: var(--card); padding: 20px; border-radius: 25px; margin-bottom: 12px; position: relative; border: 1px solid var(--border); }
        
        .overlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; transform: translateY(100%); padding: 30px; overflow-y: auto; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .overlay.active { transform: translateY(0); }

        #chat-view { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; flex-direction: column; }
        .chat-header { padding: 20px; background: var(--card); display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .chat-bubble { max-width: 80%; padding: 12px 18px; border-radius: 20px; font-size: 14px; line-height: 1.4; }
        .chat-bubble.sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 5px; }
        .chat-bubble.received { align-self: flex-start; background: var(--input-bg); border-bottom-left-radius: 5px; }
        .chat-input-area { padding: 15px; background: var(--card); display: flex; gap: 10px; border-top: 1px solid var(--border); }

        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .theme-dot { height: 45px; border-radius: 12px; cursor: pointer; border: 3px solid transparent; }
        .theme-dot.active { border-color: var(--text); }

        input, textarea, select { width: 100%; padding: 18px; border-radius: 18px; border: none; background: var(--input-bg); color: var(--text); font-size: 15px; margin-top: 8px; outline: none; }
        
        #capture-zone { position: absolute; left: -9999px; width: 450px; padding: 60px; text-align: center; color: white; }

        .switch-container { display: flex; align-items: center; justify-content: space-between; padding: 10px 5px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body id="main-body">

<div id="main-loader">
    <div class="spinner"></div>
    <p style="margin-top:20px; font-weight:800; font-size:10px; letter-spacing:3px; opacity:0.5;">ANONY'X DEV BURKINA</p>
</div>

<div class="container">
    
    <div id="view-inbox" class="hidden">
        <div class="home-header">
            <div class="profile-pill">
                <img id="my-avatar" src="" style="width:32px; height:32px; border-radius:50%; background: #000;">
                <span id="my-username-display" style="font-weight:800; font-size:14px;"></span>
            </div>
            <div style="display: flex; gap: 8px;">
                <div class="settings-circle" onclick="toggleOverlay('search-panel', true)">
                    <i class="fas fa-search"></i>
                </div>
                <div class="settings-circle" onclick="openNotifPanel()">
                    <i class="fas fa-bell"></i>
                    <div id="bell-dot" class="notif-badge"></div>
                </div>
                <div class="settings-circle" onclick="toggleOverlay('settings-panel', true)">
                    <i class="fas fa-sliders-h"></i>
                </div>
            </div>
        </div>

        <div class="ngl-card">
            <h3 style="font-size:18px; font-weight:800; margin-bottom:5px;">Ton lien personnel</h3>
            <p style="font-size:12px; opacity:0.5; margin-bottom:20px;">Partage-le pour recevoir des secrets</p>
            <button class="btn-ngl" style="background:var(--text); color:var(--bg);" onclick="copyLink()">COPIER LE LIEN ðŸ”—</button>
            <div class="share-row">
                <button class="share-btn wa" onclick="shareTo('whatsapp')"><i class="fab fa-whatsapp"></i></button>
                <button class="share-btn fb" onclick="shareTo('facebook')"><i class="fab fa-facebook-f"></i></button>
                <button class="share-btn sn" onclick="shareTo('snapchat')"><i class="fab fa-snapchat-ghost"></i></button>
            </div>
        </div>

        <div class="delirium-group">
            <button class="btn-delirium" onclick="switchView('random')">
                <i class="fas fa-dice"></i> DÃ‰LIRIUM CHAT
            </button>
            <button class="btn-delirium outline" onclick="alert('BientÃ´t disponible !')">
                <i class="fas fa-bolt"></i> FLASH
            </button>
        </div>

        <div class="history-section">
            <div class="history-label">BoÃ®te de rÃ©ception (Anonyme)</div>
            <div id="msg-container"></div>
        </div>
    </div>

    <div id="view-send" class="hidden">
        <div class="ngl-card" style="background:white; color:black; text-align:center; padding-top:40px;">
            <img id="t-avatar" src="" style="width:80px; height:80px; border-radius:50%; border:4px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-bottom:15px;">
            <div style="font-weight:900; font-size:20px; margin-bottom:20px;">@<span id="t-username"></span></div>
            <select id="msg-mood" style="background:#f2f2f7; color:black; font-weight:700;">
                <option value="gentil">ðŸ˜‡ Message Gentil</option>
                <option value="drole">ðŸ˜‚ Message DrÃ´le</option>
                <option value="audacieux">ðŸ”¥ Message Audacieux</option>
            </select>
            <textarea id="msg-text" placeholder="Ã‰cris ton message anonyme..." style="background:#f2f2f7; color:black; height:150px; text-align:center;"></textarea>
            <button class="btn-ngl" style="background:black;" onclick="sendMsg()">ENVOYER ðŸš€</button>
            <p onclick="location.href='index.html'" style="margin-top:20px; font-size:12px; color:gray; cursor:pointer;">Retour</p>
        </div>
    </div>

    <div id="view-random" class="hidden">
        <div class="ngl-card" style="text-align:center; border:2px solid var(--primary);">
            <h2 style="color:var(--primary); margin-bottom:10px;">DÃ©lirium Mode</h2>
            <p style="font-size:12px; opacity:0.6; margin-bottom:20px;">Ton message sera envoyÃ© Ã  un utilisateur au hasard.</p>
            <textarea id="random-msg-text" placeholder="Le destinataire sera une surprise..."></textarea>
            <button class="btn-ngl" style="background:var(--primary); color:white; margin-top:15px;" onclick="sendRandomMsg()">LANCER LE SECRET</button>
            <p onclick="switchView('inbox')" style="margin-top:20px; font-size:12px; cursor:pointer; opacity:0.5;">RETOUR</p>
        </div>
    </div>

    <div id="view-login" class="hidden">
        <div class="ngl-card" style="text-align:center;">
            <h2 style="margin-bottom:25px;">Lab Access</h2>
            <input type="email" id="l-email" placeholder="Email">
            <input type="password" id="l-pass" placeholder="Mot de passe">
            <button class="btn-ngl" onclick="login()">CONNEXION</button>
            <p onclick="switchView('register')" style="margin-top:20px; font-size:12px; cursor:pointer;">CrÃ©er un profil testeur</p>
        </div>
    </div>

    <div id="view-register" class="hidden">
        <div class="ngl-card">
            <h2 style="text-align:center; margin-bottom:15px;">Nouveau Profil</h2>
            <div id="avatar-grid" style="display:grid; grid-template-columns: repeat(4,1fr); gap:10px; margin-bottom:20px;"></div>
            <input type="text" id="r-user" placeholder="Nom d'utilisateur">
            <input type="email" id="r-email" placeholder="Email">
            <input type="password" id="r-pass" placeholder="Mot de passe">
            <button class="btn-ngl" onclick="register()">CRÃ‰ER MON ACCÃˆS</button>
            <p onclick="switchView('login')" style="margin-top:20px; font-size:12px; cursor:pointer; text-align:center;">DÃ©jÃ  un compte ?</p>
        </div>
    </div>
</div>

<div id="search-panel" class="overlay">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h2 style="font-weight:900;">Rechercher</h2>
        <i class="fas fa-times fa-lg" onclick="toggleOverlay('search-panel', false)"></i>
    </div>
    <input type="text" placeholder="Chercher un pseudo..." oninput="searchUsers(this.value)">
    <div id="search-results" style="margin-top:20px;"></div>
</div>

<div id="notif-panel" class="overlay">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h2 style="font-weight:900;">Inbox Sociale</h2>
        <i class="fas fa-times fa-lg" onclick="toggleOverlay('notif-panel', false)"></i>
    </div>
    <div class="history-label">Demandes d'amis</div>
    <div id="friend-requests-area" style="margin-bottom:25px;"></div>
    <div class="history-label">Tes Amis / Chats</div>
    <div id="active-chats-area"></div>
</div>

<div id="chat-view" class="hidden">
    <div class="chat-header">
        <i class="fas fa-arrow-left" onclick="closeChat()"></i>
        <img id="chat-avatar" src="" style="width:35px; height:35px; border-radius:50%;">
        <span id="chat-name" style="font-weight:800;"></span>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Ã‰cris ton message...">
        <button class="btn-ngl" onclick="sendMessage()" style="width:60px; padding:10px; margin-top:0;">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>

<div id="settings-panel" class="overlay">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h2 style="font-weight:900;">Lab Settings</h2>
        <i class="fas fa-times fa-lg" onclick="toggleOverlay('settings-panel', false)"></i>
    </div>
    <div class="history-label">Apparence</div>
    <div class="ngl-card" style="padding:15px;">
        <div class="switch-container">
            <p style="font-size:13px; font-weight:700;">Mode Sombre</p>
            <label class="switch">
                <input type="checkbox" id="dark-mode-toggle" checked onchange="toggleDarkMode(this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <hr style="opacity:0.1; margin:15px 0;">
        <p style="font-size:13px; font-weight:700; margin-bottom:10px;">ThÃ¨me visuel</p>
        <div class="theme-grid">
            <div class="theme-dot" onclick="setTheme('default', this)" style="background:#ff3e60;"></div>
            <div class="theme-dot" onclick="setTheme('royal', this)" style="background:#7000ff;"></div>
            <div class="theme-dot" onclick="setTheme('sunset', this)" style="background:#ff8c00;"></div>
            <div class="theme-dot" onclick="setTheme('emerald', this)" style="background:#00c853;"></div>
        </div>
    </div>
    <button class="btn-ngl" style="background:#ff4444; margin-bottom:12px;" onclick="deleteAllMessages()">EFFACER MESSAGES ANONYMES</button>
    <button class="btn-ngl" style="background:#333;" onclick="logout()">DÃ‰CONNEXION</button>
</div>

<div id="capture-zone">
    <div style="font-size:14px; border-bottom:2px solid white; padding-bottom:15px; margin-bottom:30px; font-weight:800; letter-spacing:4px;">WHISPERWAVE LAB</div>
    <h2 id="capture-text" style="font-size:36px; line-height:1.2; font-weight:800;"></h2>
    <div style="margin-top:60px; font-size:14px; font-weight:700;">PROJET PAR ANONY'X DEV BURKINA</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, get, push, onValue, remove, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = {
        apiKey: "AIzaSyApUxzvh01rLFkELxI65dKpBE6uEaRBrIQ",
        authDomain: "moneyfusion-epargne.firebaseapp.com",
        databaseURL: "https://moneyfusion-epargne-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "moneyfusion-epargne",
        storageBucket: "moneyfusion-epargne.firebasestorage.app",
        messagingSenderId: "973553072578",
        appId: "1:973553072578:web:7c0a31b4b6dc3f6ffb3e5b"
    };

    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let myData = null;
    let currentChatId = null;
    let selectedAvatar = "Willow";
    const seeds = ["Willow", "Aria", "Finn", "Milo", "Luna", "Zoe", "Felix", "Jasper"];

    window.onload = () => { setTimeout(() => { document.getElementById('main-loader').style.display = 'none'; }, 1500); };

    window.toggleOverlay = (id, s) => {
        document.getElementById(id).classList.toggle('active', s);
    };

    window.openNotifPanel = () => {
        toggleOverlay('notif-panel', true);
        document.getElementById('bell-dot').style.display = 'none';
    };

    window.switchView = (v) => {
        document.querySelectorAll('.container > div').forEach(el => el.classList.add('hidden'));
        document.getElementById('view-' + v).classList.remove('hidden');
    };

    window.toggleDarkMode = (isDark) => {
        if(isDark) document.body.classList.remove('light-mode');
        else document.body.classList.add('light-mode');
        localStorage.setItem('ww-dark-mode', isDark);
    };

    onAuthStateChanged(auth, user => {
        const uId = new URLSearchParams(window.location.search).get('u');
        if(uId) {
            switchView('send');
            get(ref(db, `users/${uId}`)).then(s => {
                if(s.exists()){
                    document.getElementById('t-username').textContent = s.val().username;
                    document.getElementById('t-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${s.val().avatar}`;
                }
            });
        } else if (user) {
            get(ref(db, `users/${user.uid}`)).then(s => {
                myData = s.val();
                switchView('inbox');
                document.getElementById('my-username-display').textContent = "@" + s.val().username;
                document.getElementById('my-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${s.val().avatar}`;
                loadInbox(user.uid);
                listenGlobalNotifs();
            });
        } else { switchView('login'); }
    });

    // --- RECHERCHE GLOBALE OPTIMISÃ‰E ---
    window.searchUsers = (q) => {
        const res = document.getElementById('search-results');
        if(q.length < 1) { res.innerHTML = ""; return; }
        
        get(ref(db, 'users')).then(snap => {
            res.innerHTML = "";
            let found = false;
            snap.forEach(child => {
                const u = child.val();
                // On affiche tous les comptes qui contiennent la recherche, sauf soi-mÃªme
                if(u.uid !== auth.currentUser.uid && u.username.toLowerCase().includes(q.toLowerCase())) {
                    found = true;
                    const div = document.createElement('div');
                    div.innerHTML = `<div class="ngl-card" style="padding:15px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${u.avatar}" style="width:30px; border-radius:50%;">
                            <span style="font-weight:700;">@${u.username}</span>
                        </div>
                        <button class="btn-ngl" style="width:auto; padding:8px 15px; font-size:11px;" onclick="sendFriendRequest('${u.uid}', '${u.username}')">INVITER</button>
                    </div>`;
                    res.appendChild(div);
                }
            });
            if(!found) res.innerHTML = "<p style='text-align:center; opacity:0.5;'>Aucun utilisateur trouvÃ©</p>";
        });
    };

    window.sendFriendRequest = (targetUid, targetName) => {
        update(ref(db, `friend_requests/${targetUid}/${auth.currentUser.uid}`), {
            fromId: auth.currentUser.uid,
            fromName: myData.username,
            timestamp: Date.now(),
            status: 'pending'
        }).then(() => {
            alert("Invitation envoyÃ©e Ã  @" + targetName);
        });
    };

    // --- NOTIFICATIONS ET AMIS ---
    function listenGlobalNotifs() {
        // Points de notifications (Invitations)
        onValue(ref(db, `friend_requests/${auth.currentUser.uid}`), snap => {
            const area = document.getElementById('friend-requests-area'); 
            area.innerHTML = "";
            if(snap.exists()) {
                document.getElementById('bell-dot').style.display = 'block';
                snap.forEach(child => {
                    const r = child.val();
                    const div = document.createElement('div');
                    div.innerHTML = `<div class="ngl-card" style="padding:15px; border:1px solid var(--primary); display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span style="font-size:12px; font-weight:800;">@${r.fromName}</span>
                        <button class="btn-ngl" style="width:auto; padding:8px 15px; font-size:11px; background:var(--accent); color:black;" onclick="acceptFriend('${r.fromId}', '${r.fromName}')">ACCEPTER</button>
                    </div>`;
                    area.appendChild(div);
                });
            }
        });

        // Liste des Amis et Chats
        onValue(ref(db, `friends/${auth.currentUser.uid}`), snap => {
            const area = document.getElementById('active-chats-area'); 
            area.innerHTML = "";
            if(!snap.exists()) {
                area.innerHTML = "<p style='text-align:center; opacity:0.3; font-size:12px;'>Pas encore d'amis</p>";
                return;
            }
            snap.forEach(child => {
                const f = child.val();
                const div = document.createElement('div');
                div.innerHTML = `<div class="ngl-card" style="padding:15px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; cursor:pointer;" onclick="openChat('${f.chatId}', '${child.key}', '${f.name}')">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:10px; height:10px; background:var(--accent); border-radius:50%;"></div>
                        <span style="font-weight:800;">@${f.name}</span>
                    </div>
                    <i class="fas fa-comment-alt" style="opacity:0.5;"></i>
                </div>`;
                area.appendChild(div);
            });
        });

        // Notification pour nouveaux messages anonymes
        onValue(ref(db, `ngl_messages/${auth.currentUser.uid}`), snap => {
            if(snap.exists()) {
                // On peut aussi dÃ©clencher le point rouge pour un nouveau message anonyme
                document.getElementById('bell-dot').style.display = 'block';
            }
        });
    }

    window.acceptFriend = (fromId, fromName) => {
        const chatId = [auth.currentUser.uid, fromId].sort().join('_');
        const now = Date.now();
        update(ref(db, `friends/${auth.currentUser.uid}/${fromId}`), { name: fromName, chatId: chatId, lastActivity: now });
        update(ref(db, `friends/${fromId}/${auth.currentUser.uid}`), { name: myData.username, chatId: chatId, lastActivity: now });
        remove(ref(db, `friend_requests/${auth.currentUser.uid}/${fromId}`));
        alert("Ami ajoutÃ© !");
    };

    window.openChat = (chatId, targetUid, targetName) => {
        currentChatId = chatId;
        document.getElementById('chat-view').classList.remove('hidden');
        document.getElementById('chat-name').textContent = "@" + targetName;
        
        get(ref(db, `users/${targetUid}`)).then(s => {
            if(s.exists()) document.getElementById('chat-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${s.val().avatar}`;
        });

        onValue(ref(db, `messages/${chatId}`), snap => {
            const box = document.getElementById('chat-messages'); box.innerHTML = "";
            snap.forEach(c => {
                const m = c.val();
                const div = document.createElement('div');
                div.className = `chat-bubble ${m.sender === auth.currentUser.uid ? 'sent' : 'received'}`;
                div.textContent = m.text;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
        toggleOverlay('notif-panel', false);
    };

    window.sendMessage = () => {
        const input = document.getElementById('chat-input');
        if(!input.value.trim()) return;
        const now = Date.now();
        push(ref(db, `messages/${currentChatId}`), { 
            sender: auth.currentUser.uid, 
            text: input.value, 
            timestamp: now 
        });
        input.value = "";
    };

    window.closeChat = () => document.getElementById('chat-view').classList.add('hidden');

    // --- MESSAGES ANONYMES ---
    function loadInbox(uid) {
        onValue(ref(db, `ngl_messages/${uid}`), snap => {
            const cont = document.getElementById('msg-container'); cont.innerHTML = "";
            if(!snap.exists()) { 
                cont.innerHTML = `<p style='text-align:center; opacity:0.3; padding:40px; font-size:12px;'>Ta boÃ®te est vide</p>`; 
                return; 
            }
            snap.forEach(m => {
                const div = document.createElement('div');
                div.className = "msg-bubble";
                div.innerHTML = `
                    <p style="font-weight:700; margin-bottom:15px; font-size:15px; line-height:1.4;">${m.val().text}</p>
                    <button class="btn-ngl" style="padding:10px; font-size:11px; background:var(--input-bg); color:var(--text)" onclick="downloadMsg('${m.val().text.replace(/'/g, "\\'")}')">CAPTURE ðŸ“¸</button>
                `;
                cont.prepend(div);
            });
        });
    }

    window.sendMsg = () => {
        const t = document.getElementById('msg-text').value;
        const uId = new URLSearchParams(window.location.search).get('u');
        if(!t) return;
        push(ref(db, `ngl_messages/${uId}`), { text: t, time: Date.now() }).then(() => {
            alert("Secret envoyÃ© !");
            window.location.href = "index.html";
        });
    };

    window.sendRandomMsg = () => {
        const text = document.getElementById('random-msg-text').value;
        if(!text) return;
        get(ref(db, `users`)).then(snap => {
            const users = []; snap.forEach(u => { if(u.key !== auth.currentUser.uid) users.push(u.key); });
            if(users.length === 0) { alert("Tu es seul ici pour l'instant..."); return; }
            const luckyOne = users[Math.floor(Math.random() * users.length)];
            push(ref(db, `ngl_messages/${luckyOne}`), { text: "[ðŸŽ²] " + text, time: Date.now() });
            alert("Secret propulsÃ© !");
            switchView('inbox');
            document.getElementById('random-msg-text').value = "";
        });
    };

    // --- AUTH ET PARAMETRES ---
    window.login = () => { 
        const e = document.getElementById('l-email').value;
        const p = document.getElementById('l-pass').value;
        signInWithEmailAndPassword(auth, e, p).catch(err => alert("Identifiants incorrects")); 
    };

    window.register = () => {
        const u = document.getElementById('r-user').value;
        const e = document.getElementById('r-email').value;
        const p = document.getElementById('r-pass').value;
        if(!u || !e || !p) return alert("Remplis tout !");
        createUserWithEmailAndPassword(auth, e, p).then(r => {
            set(ref(db, `users/${r.user.uid}`), { username: u, avatar: selectedAvatar, uid: r.user.uid });
        }).catch(err => alert("Erreur: " + err.message));
    };

    window.logout = () => signOut(auth).then(() => location.reload());

    window.copyLink = () => {
        const l = window.location.origin + window.location.pathname + "?u=" + auth.currentUser.uid;
        navigator.clipboard.writeText(l); alert("Lien copiÃ© dans le presse-papier !");
    };

    window.shareTo = (p) => {
        const link = window.location.origin + window.location.pathname + "?u=" + auth.currentUser.uid;
        const text = encodeURIComponent("Envoie-moi des messages anonymes sur WhisperWave ! ðŸ¤«\n" + link);
        if(p === 'whatsapp') window.open(`https://wa.me/?text=${text}`);
        if(p === 'facebook') window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`);
        if(p === 'snapchat') { navigator.clipboard.writeText(link); alert("Lien copiÃ© pour Snapchat !"); }
    };

    window.downloadMsg = (text) => {
        const zone = document.getElementById('capture-zone');
        document.getElementById('capture-text').textContent = text;
        zone.style.backgroundColor = getComputedStyle(document.body).getPropertyValue('--primary');
        html2canvas(zone).then(canvas => {
            const link = document.createElement('a');
            link.download = "WhisperSecret.png";
            link.href = canvas.toDataURL(); link.click();
        });
    };

    window.setTheme = (t, el) => {
        document.body.classList.remove('theme-royal', 'theme-sunset', 'theme-emerald');
        if(t !== 'default') document.body.classList.add('theme-' + t);
        document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
        el.classList.add('active');
        localStorage.setItem('ww-theme', t);
    };

    window.deleteAllMessages = () => {
        if(confirm("Supprimer dÃ©finitivement tes messages anonymes ?")) {
            remove(ref(db, `ngl_messages/${auth.currentUser.uid}`));
            toggleOverlay('settings-panel', false);
        }
    };

    // Init Avatar Grid
    const grid = document.getElementById('avatar-grid');
    seeds.forEach(s => {
        const img = document.createElement('img');
        img.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${s}`;
        img.style = "width:100%; border-radius:50%; cursor:pointer; background:#222; padding:5px; border:2px solid transparent;";
        img.onclick = () => {
            Array.from(grid.children).forEach(c => c.style.borderColor = "transparent");
            img.style.borderColor = "var(--primary)";
            selectedAvatar = s;
        };
        grid.appendChild(img);
    });

    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('ww-theme') || 'default';
        const isDarkMode = localStorage.getItem('ww-dark-mode') !== 'false';
        document.getElementById('dark-mode-toggle').checked = isDarkMode;
        toggleDarkMode(isDarkMode);
        if(savedTheme !== 'default') document.body.classList.add('theme-' + savedTheme);
    });
</script>
</body>
</html>
