<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhisperWave | Ultimate Lab</title>
    <meta property="og:title" content="WhisperWave | Ultimate Lab">
    <meta property="og:description" content="Envoie-moi des messages anonymes sur WhisperWave ! ü§´">
    <meta property="og:image" content="https://api.dicebear.com/7.x/avataaars/svg?seed=WhisperWave">
    <meta property="og:url" content="https://yourdomain.com/index.html">
    <meta property="og:type" content="website">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* VARIABLES CSS ADAPTATIVES - GARD√âES ORIGINALES */
        :root { 
            --primary: #ff3e60; 
            --bg: #0b0b0b; 
            --card: #1c1c1e; 
            --text: #ffffff; 
            --text-dim: rgba(255,255,255,0.4);
            --accent: #00ff88; 
            --shadow: 0 10px 40px rgba(0,0,0,0.6); 
            --input-bg: #2c2c2e;
            --border: rgba(255,255,255,0.05);
        }

        /* MODE CLAIR */
        body.light-mode {
            --bg: #f2f2f7;
            --card: #ffffff;
            --text: #1c1c1e;
            --text-dim: rgba(0,0,0,0.5);
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --input-bg: #e5e5ea;
            --border: rgba(0,0,0,0.05);
        }

        /* THEMES DE COULEURS ACCENTU√âES */
        body.theme-royal { --primary: #7000ff; }
        body.theme-sunset { --primary: #ff8c00; }
        body.theme-emerald { --primary: #00c853; }
        
        body.theme-royal:not(.light-mode) { --bg: #0d011a; }
        body.theme-sunset:not(.light-mode) { --bg: #1a0f00; }
        body.theme-emerald:not(.light-mode) { --bg: #001207; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; transition: background 0.3s, color 0.3s, transform 0.2s; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; position: relative; }
        
        /* LOADER */
        #main-loader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 3px solid rgba(128,128,128,0.2); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .container { width: 100%; max-width: 420px; margin: auto; padding: 20px; padding-bottom: 100px; }
        .hidden { display: none !important; }

        /* CARDS & BUTTONS */
        .ngl-card { background: var(--card); border-radius: 30px; padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 20px; }
        .btn-ngl { width: 100%; padding: 18px; border-radius: 22px; border: none; font-weight: 800; cursor: pointer; background: var(--primary); color: white; font-size: 15px; letter-spacing: 0.5px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .btn-ngl:active { transform: scale(0.97); }

        /* DOUBLE BUTTON DELIRIUM STYLE */
        .delirium-group { display: grid; grid-template-columns: 1.5fr 1fr; gap: 10px; margin-bottom: 30px; }
        .btn-delirium { background: var(--primary); color: white; border-radius: 20px; border: none; font-weight: 800; padding: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; text-transform: uppercase; }
        .btn-delirium.outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* HEADER ACCUEIL */
        .home-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
        .profile-pill { display: flex; align-items: center; gap: 12px; background: var(--card); padding: 8px 15px; border-radius: 50px; border: 1px solid var(--border); }
        .settings-circle { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; background: var(--card); border-radius: 50%; cursor: pointer; border: 1px solid var(--border); position: relative; }
        .notif-badge { position: absolute; top: 0; right: 0; width: 18px; height: 18px; background: #ff4444; border-radius: 50%; border: 2px solid var(--bg); display: none; font-size: 10px; font-weight: 900; display: flex; align-items: center; justify-content: center; }

        /* SOCIAL SHARE */
        .share-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; }
        .share-btn { height: 50px; border-radius: 18px; border: none; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; cursor: pointer; }
        .wa { background: #25D366; } .fb { background: #1877F2; } .sn { background: #FFFC00; color: #000; }

        /* ZONE HISTORIQUE */
        .history-section { margin-top: 30px; }
        .history-label { font-size: 11px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; padding-left: 10px; }
        .msg-bubble { background: var(--card); padding: 20px; border-radius: 25px; margin-bottom: 12px; position: relative; border: 1px solid var(--border); }
        
        /* STYLE POUR MESSAGE TRONQU√â/COMPLET */
        .message-preview { 
            font-weight: 700; 
            margin-bottom: 15px; 
            font-size: 15px; 
            line-height: 1.4;
            cursor: pointer;
            position: relative;
            max-height: 4.2em; /* ~3 lignes */
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .message-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 60px;
            height: 1.5em;
            background: linear-gradient(to right, transparent, var(--card) 50%);
        }
        .message-preview.expanded {
            max-height: 500px; /* Suffisamment grand pour tout le contenu */
        }
        .message-preview.expanded::after {
            display: none;
        }
        .message-preview .read-more {
            color: var(--primary);
            font-weight: 800;
            font-size: 12px;
            position: absolute;
            right: 0;
            bottom: 0;
            background: var(--card);
            padding-left: 10px;
            cursor: pointer;
            z-index: 2;
        }
        
        /* BARRE DE NAVIGATION INF√âRIEURE - CORRIG√âE */
        .bottom-nav { 
            position: fixed; 
            bottom: 15px; 
            left: 50%; 
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 420px;
            background: var(--card); 
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 10px 15px;
            z-index: 2000; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
            background: rgba(28, 28, 30, 0.85);
        }
        body.light-mode .bottom-nav {
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .nav-btn { 
            background: none; 
            border: none; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: var(--text-dim); 
            gap: 4px; 
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px 10px;
            border-radius: 15px;
            min-width: 60px;
            position: relative;
        }
        .nav-btn.active { 
            color: var(--primary); 
            background: rgba(255, 62, 96, 0.1);
        }
        .nav-btn i { 
            font-size: 20px; 
        }
        .nav-btn span { 
            font-size: 10px; 
            font-weight: 700; 
            letter-spacing: 0.5px;
        }
        .nav-add-btn {
            background: var(--primary); 
            border: none; 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            box-shadow: 0 5px 15px rgba(255, 62, 96, 0.4);
            cursor: pointer;
            position: relative;
            top: -5px;
        }
        .nav-add-btn i {
            color: white; 
            font-size: 20px;
        }
        
        /* OVERLAYS */
        .overlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; transform: translateY(100%); padding: 30px; overflow-y: auto; }
        .overlay.active { transform: translateY(0); }

        /* CHAT WINDOW STYLE */
        #chat-view { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; flex-direction: column; }
        .chat-header { padding: 20px; background: var(--card); display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .chat-bubble { max-width: 80%; padding: 12px 18px; border-radius: 20px; font-size: 14px; }
        .chat-bubble.sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 5px; }
        .chat-bubble.received { align-self: flex-start; background: var(--input-bg); border-bottom-left-radius: 5px; }
        .chat-input-area { padding: 15px; background: var(--card); display: flex; gap: 10px; border-top: 1px solid var(--border); }

        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .theme-dot { height: 45px; border-radius: 12px; cursor: pointer; border: 3px solid transparent; }
        .theme-dot.active { border-color: var(--text); }

        input, textarea, select { width: 100%; padding: 18px; border-radius: 18px; border: none; background: var(--input-bg); color: var(--text); font-size: 15px; margin-top: 8px; outline: none; }
        
        #capture-zone { position: absolute; left: -9999px; width: 450px; padding: 60px; text-align: center; color: white; }

        .switch-container { display: flex; align-items: center; justify-content: space-between; padding: 10px 5px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }
        
        /* POP-IN ANIMATIONS */
        .popin { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); background: var(--card); padding: 30px; border-radius: 25px; z-index: 9999; box-shadow: 0 20px 60px rgba(0,0,0,0.5); opacity: 0; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); border: 1px solid var(--border); max-width: 300px; width: 90%; text-align: center; }
        .popin.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        .popin-icon { font-size: 50px; margin-bottom: 20px; color: var(--primary); }
        .popin-text { font-weight: 800; font-size: 18px; margin-bottom: 10px; }
        .popin-subtext { font-size: 12px; opacity: 0.7; margin-bottom: 20px; }
        
        /* ITEM DE DEMANDE D'AMI */
        .friend-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--card); border-radius: 20px; margin-bottom: 10px; border: 1px solid var(--border); }
        
        /* POUR LES T√âL√âPHONES AVEC ENCOCHE (SAFE AREA) */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-nav {
                padding-bottom: calc(10px + env(safe-area-inset-bottom));
                bottom: calc(15px + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body id="main-body">

<div id="main-loader">
    <div class="spinner"></div>
    <p style="margin-top:20px; font-weight:800; font-size:10px; letter-spacing:3px; opacity:0.5;">ANONY'X DEV BURKINA</p>
</div>

<!-- POP-IN POUR CONFIRMATIONS -->
<div id="popin-success" class="popin hidden">
    <div class="popin-icon">‚úÖ</div>
    <div class="popin-text" id="popin-success-text">Succ√®s !</div>
    <div class="popin-subtext" id="popin-success-subtext">Op√©ration r√©ussie</div>
    <button class="btn-ngl" onclick="hidePopin()" style="padding: 12px; font-size: 13px;">OK</button>
</div>

<div id="popin-error" class="popin hidden">
    <div class="popin-icon">‚ùå</div>
    <div class="popin-text" id="popin-error-text">Erreur</div>
    <div class="popin-subtext" id="popin-error-subtext">Une erreur est survenue</div>
    <button class="btn-ngl" onclick="hidePopin()" style="padding: 12px; font-size: 13px; background: #ff4444;">OK</button>
</div>

<!-- POP-IN POUR VOIR MESSAGE COMPLET -->
<div id="popin-message" class="popin hidden">
    <div class="popin-icon">ü§´</div>
    <div class="popin-text">Message Secret</div>
    <div class="popin-subtext" id="popin-message-content" style="text-align:left; padding:15px; background:var(--input-bg); border-radius:15px; margin:15px 0; max-height:200px; overflow-y:auto; white-space: pre-wrap;"></div>
    <button class="btn-ngl" onclick="hideMessagePopin()" style="padding: 12px; font-size: 13px;">RETOUR</button>
</div>

<div class="container">
    
    <div id="view-inbox" class="hidden">
        <div class="home-header">
            <div class="profile-pill">
                <img id="my-avatar" src="" style="width:32px; height:32px; border-radius:50%; background: #000;">
                <span id="my-username-display" style="font-weight:800; font-size:14px;"></span>
            </div>
            <div style="display: flex; gap: 8px;">
                <div class="settings-circle" onclick="toggleOverlay('settings-panel', true)">
                    <i class="fas fa-sliders-h"></i>
                </div>
            </div>
        </div>

        <div class="ngl-card">
            <h3 style="font-size:18px; font-weight:800; margin-bottom:5px;">Ton lien personnel</h3>
            <p style="font-size:12px; opacity:0.5; margin-bottom:20px;">Partage-le pour recevoir des secrets</p>
            <button class="btn-ngl" style="background:var(--text); color:var(--bg);" onclick="copyLink()">COPIER LE LIEN üîó</button>
            <div class="share-row">
                <button class="share-btn wa" onclick="shareTo('whatsapp')"><i class="fab fa-whatsapp"></i></button>
                <button class="share-btn fb" onclick="shareTo('facebook')"><i class="fab fa-facebook-f"></i></button>
                <button class="share-btn sn" onclick="shareTo('snapchat')"><i class="fab fa-snapchat-ghost"></i></button>
            </div>
        </div>

        <div class="delirium-group">
            <button class="btn-delirium" onclick="switchView('random')">
                <i class="fas fa-dice"></i> D√âLIRIUM CHAT
            </button>
            <button class="btn-delirium outline" onclick="toggleOverlay('notif-panel', true)">
                <i class="fas fa-bell"></i> NOTIFICATIONS
                <div id="bell-dot" class="notif-badge" style="position: static; margin-left: 5px;">0</div>
            </button>
        </div>

        <div class="history-section">
            <div class="history-label">Bo√Æte de r√©ception <span id="message-count-badge" style="background:var(--primary); color:white; padding:2px 8px; border-radius:10px; font-size:9px; margin-left:5px; display:none;">0</span></div>
            <div id="msg-container"></div>
        </div>
    </div>

    <div id="view-chats" class="hidden">
        <div class="home-header">
            <div class="profile-pill">
                <img id="my-avatar-chats" src="" style="width:32px; height:32px; border-radius:50%; background: #000;">
                <span id="my-username-display-chats" style="font-weight:800; font-size:14px;"></span>
            </div>
            <div style="display: flex; gap: 8px;">
                <div class="settings-circle" onclick="toggleOverlay('search-panel', true)">
                    <i class="fas fa-search"></i>
                </div>
            </div>
        </div>

        <div class="ngl-card" style="text-align:center; border:2px solid var(--primary);">
            <h2 style="color:var(--primary); margin-bottom:10px;">Mes Conversations</h2>
            <p style="font-size:12px; opacity:0.6; margin-bottom:20px;">Discute avec tes amis</p>
        </div>

        <div class="history-section">
            <div class="history-label">Mes amis</div>
            <div id="chats-list"></div>
        </div>
    </div>

    <div id="view-send" class="hidden">
        <div class="ngl-card" style="background:white; color:black; text-align:center; padding-top:40px;">
            <img id="t-avatar" src="" style="width:80px; height:80px; border-radius:50%; border:4px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-bottom:15px;">
            <div style="font-weight:900; font-size:20px; margin-bottom:20px;">@<span id="t-username"></span></div>
            <textarea id="msg-text" placeholder="√âcris ton message anonyme..." style="background:#f2f2f7; color:black; height:150px; text-align:center;"></textarea>
            <button class="btn-ngl" style="background:black;" onclick="sendMsg()">ENVOYER üöÄ</button>
        </div>
    </div>

    <div id="view-random" class="hidden">
        <div class="ngl-card" style="text-align:center; border:2px solid var(--primary);">
            <h2 style="color:var(--primary); margin-bottom:10px;">D√©lirium Mode</h2>
            <p style="font-size:12px; opacity:0.6; margin-bottom:20px;">Ton message sera envoy√© √† un utilisateur au hasard.</p>
            <textarea id="random-msg-text" placeholder="Le destinataire sera une surprise..."></textarea>
            <button class="btn-ngl" style="background:var(--primary); color:white; margin-top:15px;" onclick="sendRandomMsg()">LANCER LE SECRET</button>
            <p onclick="switchToNav('inbox')" style="margin-top:20px; font-size:12px; cursor:pointer; opacity:0.5;">RETOUR</p>
        </div>
    </div>

    <div id="view-login" class="hidden">
        <div class="ngl-card" style="text-align:center;">
            <h2 style="margin-bottom:25px;">Lab Access</h2>
            <input type="email" id="l-email" placeholder="Email">
            <input type="password" id="l-pass" placeholder="Mot de passe">
            <button class="btn-ngl" onclick="login()">CONNEXION</button>
            <p onclick="switchView('register')" style="margin-top:20px; font-size:12px; cursor:pointer;">Cr√©er un profil testeur</p>
        </div>
    </div>

    <div id="view-register" class="hidden">
        <div class="ngl-card">
            <h2 style="text-align:center; margin-bottom:15px;">Nouveau Profil</h2>
            <div id="avatar-grid" style="display:grid; grid-template-columns: repeat(4,1fr); gap:10px; margin-bottom:20px;"></div>
            <input type="text" id="r-user" placeholder="Username">
            <input type="email" id="r-email" placeholder="Email">
            <input type="password" id="r-pass" placeholder="Mot de passe">
            <button class="btn-ngl" onclick="register()">CR√âER MON ACC√àS</button>
        </div>
    </div>
</div>

<!-- BARRE DE NAVIGATION INF√âRIEURE - NOUVELLE VERSION -->
<div id="bottom-nav" class="hidden">
    <button id="nav-home" class="nav-btn active" onclick="switchToNav('inbox')">
        <i class="fas fa-home"></i>
        <span>ACCUEIL</span>
    </button>
    
    <button id="nav-chats" class="nav-btn" onclick="switchToNav('chats')">
        <i class="fas fa-comment-alt"></i>
        <span>CHATS</span>
    </button>
    
    <button class="nav-add-btn" onclick="toggleOverlay('search-panel', true)">
        <i class="fas fa-plus"></i>
    </button>
    
    <button id="nav-random" class="nav-btn" onclick="switchView('random')">
        <i class="fas fa-dice"></i>
        <span>D√âLIRIUM</span>
    </button>
    
    <button id="nav-notif" class="nav-btn" onclick="toggleOverlay('notif-panel', true)">
        <i class="fas fa-bell"></i>
        <span>NOTIFS</span>
        <div id="mobile-bell-dot" class="notif-badge" style="position:absolute; top:0; right:5px; display:none;"></div>
    </button>
</div>

<div id="search-panel" class="overlay">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h2 style="font-weight:900;">Rechercher</h2>
        <i class="fas fa-times fa-lg" onclick="toggleOverlay('search-panel', false)"></i>
    </div>
    <input type="text" id="search-input" placeholder="Chercher un pseudo..." oninput="debounceSearch(this.value)">
    <div id="search-results" style="margin-top:20px;"></div>
</div>

<div id="notif-panel" class="overlay">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h2 style="font-weight:900;">Notifications</h2>
        <i class="fas fa-times fa-lg" onclick="toggleOverlay('notif-panel', false)"></i>
    </div>
    <div class="history-label">Demandes d'amis <span id="friend-requests-count" style="background:var(--primary); color:white; padding:2px 8px; border-radius:10px; font-size:9px; margin-left:5px;">0</span></div>
    <div id="friend-requests-area" style="margin-bottom:25px;"></div>
</div>

<div id="chat-view" class="hidden">
    <div class="chat-header">
        <i class="fas fa-arrow-left" onclick="closeChat()"></i>
        <img id="chat-avatar" src="" style="width:35px; border-radius:50%;">
        <span id="chat-name" style="font-weight:800;"></span>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Message..." onkeypress="handleChatKeyPress(event)">
        <button class="btn-ngl" onclick="sendMessage()" style="width:60px; padding:10px; margin-top:0;">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>

<div id="settings-panel" class="overlay">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h2 style="font-weight:900;">Lab Settings</h2>
        <i class="fas fa-times fa-lg" onclick="toggleOverlay('settings-panel', false)"></i>
    </div>
    <div style="color:var(--text-dim); font-size:11px; font-weight:800; text-transform:uppercase; margin-bottom:10px; padding-left:10px;">Apparence</div>
    <div class="ngl-card" style="padding:15px;">
        <div class="switch-container">
            <p style="font-size:13px; font-weight:700;">Mode Sombre</p>
            <label class="switch">
                <input type="checkbox" id="dark-mode-toggle" checked onchange="toggleDarkMode(this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <hr style="opacity:0.1; margin:15px 0;">
        <p style="font-size:13px; font-weight:700; margin-bottom:10px;">Th√®me visuel</p>
        <div class="theme-grid">
            <div class="theme-dot" onclick="setTheme('default', this)" style="background:#ff3e60;"></div>
            <div class="theme-dot" onclick="setTheme('royal', this)" style="background:#7000ff;"></div>
            <div class="theme-dot" onclick="setTheme('sunset', this)" style="background:#ff8c00;"></div>
            <div class="theme-dot" onclick="setTheme('emerald', this)" style="background:#00c853;"></div>
        </div>
    </div>
    <div style="color:var(--text-dim); font-size:11px; font-weight:800; text-transform:uppercase; margin-bottom:10px; padding-left:10px;">√Ä Propos du Lab</div>
    <div class="ngl-card" style="padding:20px;">
        <p style="font-weight:800; color:var(--primary); font-size:12px; margin-bottom:5px;">MISSION</p>
        <p style="font-size:12px; line-height:1.5; opacity:0.8; margin-bottom:15px;">WhisperWave est un laboratoire d'exp√©rimentation sur l'anonymat num√©rique et la s√©curit√© des donn√©es.</p>
        <p style="font-weight:800; color:var(--accent); font-size:12px; margin-bottom:5px;">CR√âATEUR</p>
        <p style="font-size:12px; opacity:0.8;">D√©velopp√© avec passion par <strong>Anony'X Dev Burkina</strong>.</p>
    </div>
    <div style="color:var(--text-dim); font-size:11px; font-weight:800; text-transform:uppercase; margin-bottom:10px; padding-left:10px;">Actions</div>
    <button class="btn-ngl" style="background:#ff4444; margin-bottom:12px; padding:12px; font-size:12px;" onclick="deleteAllMessages()">EFFACER L'HISTORIQUE</button>
    <button class="btn-ngl" style="background:#333; color:white; padding:12px; font-size:12px;" onclick="logout()">D√âCONNEXION</button>
</div>

<div id="capture-zone">
    <div style="font-size:14px; border-bottom:2px solid white; padding-bottom:15px; margin-bottom:30px; font-weight:800; letter-spacing:4px;">WHISPERWAVE LAB</div>
    <h2 id="capture-text" style="font-size:36px; line-height:1.2; font-weight:800;"></h2>
    <div style="margin-top:60px; font-size:14px; font-weight:700;">PROJET PAR ANONY'X DEV BURKINA</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, get, push, onValue, remove, update, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // VOS CONFIGURATIONS FIREBASE
    const config = {
        apiKey: "AIzaSyDotXQ6BeZ7QIwEaOV0i3v-MWfPRZbJIQQ",
        authDomain: "wsano-ff258.firebaseapp.com",
        databaseURL: "https://wsano-ff258-default-rtdb.firebaseio.com",
        projectId: "wsano-ff258",
        storageBucket: "wsano-ff258.firebasestorage.app",
        messagingSenderId: "174753911652",
        appId: "1:174753911652:web:f189c118daa6eff822a071"
    };

    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let myData = null;
    let currentChatId = null;
    let currentChatTargetUid = null;
    let selectedAvatar = "Willow";
    const seeds = ["Willow", "Aria", "Finn", "Milo", "Luna", "Zoe", "Felix", "Jasper"];
    let chatListener = null;
    let debounceTimer = null;
    let unreadMessagesCount = 0;
    let unreadFriendRequestsCount = 0;
    let currentNavView = 'inbox';

    // --- NOUVELLES FONCTIONS POUR MESSAGES ---
    window.showMessagePopin = (text) => {
        const contentDiv = document.getElementById('popin-message-content');
        contentDiv.textContent = text;
        document.getElementById('popin-message').classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('popin-message').classList.add('show');
        }, 10);
    };

    window.hideMessagePopin = () => {
        document.getElementById('popin-message').classList.remove('show');
        setTimeout(() => {
            document.getElementById('popin-message').classList.add('hidden');
        }, 300);
    };

    // --- FONCTIONS POP-IN ---
    window.showSuccessPopin = (text, subtext) => {
        document.getElementById('popin-success-text').textContent = text;
        document.getElementById('popin-success-subtext').textContent = subtext || '';
        document.getElementById('popin-success').classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('popin-success').classList.add('show');
        }, 10);
    };

    window.showErrorPopin = (text, subtext) => {
        document.getElementById('popin-error-text').textContent = text;
        document.getElementById('popin-error-subtext').textContent = subtext || '';
        document.getElementById('popin-error').classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('popin-error').classList.add('show');
        }, 10);
    };

    window.hidePopin = () => {
        document.getElementById('popin-success').classList.remove('show');
        document.getElementById('popin-error').classList.remove('show');
        setTimeout(() => {
            document.getElementById('popin-success').classList.add('hidden');
            document.getElementById('popin-error').classList.add('hidden');
        }, 300);
    };

    window.onload = () => { 
        setTimeout(() => { 
            document.getElementById('main-loader').style.display = 'none'; 
        }, 1000); 
    };

    window.toggleOverlay = (id, s) => {
        document.getElementById(id).classList.toggle('active', s);
        if(id === 'notif-panel' && s) {
            updateNotificationBadge(0);
        }
    };

    // Nouvelle fonction pour la navigation avec barre
    window.switchToNav = (v) => {
        currentNavView = v;
        
        // Mettre √† jour les boutons actifs
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        if(v === 'inbox') {
            document.getElementById('nav-home').classList.add('active');
            switchView('inbox');
        } else if(v === 'chats') {
            document.getElementById('nav-chats').classList.add('active');
            switchView('chats');
        }
    };

    window.switchView = (v) => {
        document.querySelectorAll('.container > div').forEach(el => el.classList.add('hidden'));
        document.getElementById('view-' + v).classList.remove('hidden');
        
        // Afficher ou cacher la barre de navigation
        if(v === 'inbox' || v === 'chats' || v === 'random') {
            document.getElementById('bottom-nav').classList.remove('hidden');
        } else if(v === 'login' || v === 'register' || v === 'send') {
            document.getElementById('bottom-nav').classList.add('hidden');
        }
        
        // Mettre √† jour les avatars si n√©cessaire
        if(v === 'chats' && myData) {
            document.getElementById('my-avatar-chats').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${myData.avatar}`;
            document.getElementById('my-username-display-chats').textContent = "@" + myData.username;
        }
    };

    window.toggleDarkMode = (isDark) => {
        if(isDark) { document.body.classList.remove('light-mode'); } 
        else { document.body.classList.add('light-mode'); }
        localStorage.setItem('ww-dark-mode', isDark);
    };

    onAuthStateChanged(auth, user => {
        const uId = new URLSearchParams(window.location.search).get('u');
        if(uId) {
            switchView('send');
            get(ref(db, `users/${uId}`)).then(s => {
                if(s.exists()){
                    document.getElementById('t-username').textContent = s.val().username;
                    document.getElementById('t-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${s.val().avatar}`;
                } else {
                    showErrorPopin("Utilisateur non trouv√©", "Le lien semble invalide");
                    setTimeout(() => window.location.href = "index.html", 2000);
                }
            }).catch(error => {
                console.error("Erreur de chargement de l'utilisateur:", error);
            });
        } else if (user) {
            get(ref(db, `users/${user.uid}`)).then(s => {
                if(s.exists()) {
                    myData = s.val();
                    switchToNav('inbox');
                    document.getElementById('my-username-display').textContent = "@" + s.val().username;
                    document.getElementById('my-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${s.val().avatar}`;
                    loadInbox(user.uid);
                    listenFriendsAndRequests();
                    listenFriendRequestsCount();
                    loadChatsList();
                } else {
                    const username = "User_" + user.uid.substring(0, 6);
                    const avatar = seeds[Math.floor(Math.random() * seeds.length)];
                    set(ref(db, `users/${user.uid}`), { 
                        username: username, 
                        avatar: avatar, 
                        uid: user.uid,
                        createdAt: Date.now(),
                        email: user.email
                    }).then(() => {
                        location.reload();
                    });
                }
            });
        } else { 
            switchView('login'); 
        }
    });

    // --- FONCTIONS DE GESTION DES NOTIFICATIONS ---

    function updateNotificationBadge(count) {
        const badge = document.getElementById('bell-dot');
        const mobileBadge = document.getElementById('mobile-bell-dot');
        
        if(count > 0) {
            badge.style.display = 'flex';
            mobileBadge.style.display = 'flex';
            badge.textContent = count > 99 ? '99+' : count;
            mobileBadge.textContent = count > 99 ? '99+' : count;
        } else {
            badge.style.display = 'none';
            mobileBadge.style.display = 'none';
        }
        document.title = count > 0 ? `(${count}) WhisperWave` : 'WhisperWave';
    }

    function listenFriendRequestsCount() {
        if(!auth.currentUser) return;
        
        onValue(ref(db, `friend_requests/${auth.currentUser.uid}`), snap => {
            let count = 0;
            if(snap.exists()) {
                snap.forEach(() => {
                    count++;
                });
            }
            unreadFriendRequestsCount = count;
            document.getElementById('friend-requests-count').textContent = count;
            
            const totalNotifications = unreadFriendRequestsCount + unreadMessagesCount;
            updateNotificationBadge(totalNotifications);
        });
    }

    // --- RECHERCHE D'UTILISATEURS ---

    window.debounceSearch = (q) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => searchUsers(q), 300);
    };

    window.searchUsers = (q) => {
        if(!auth.currentUser || !myData) return;
        q = q.trim().toLowerCase();
        if(q.length < 2) {
            document.getElementById('search-results').innerHTML = "";
            return;
        }
        
        get(ref(db, 'users')).then(snap => {
            const res = document.getElementById('search-results'); 
            res.innerHTML = "";
            
            if(!snap.exists()) {
                res.innerHTML = `<p style='text-align:center; padding:20px; opacity:0.5;'>Aucun utilisateur trouv√©</p>`;
                return;
            }
            
            const users = [];
            snap.forEach(child => {
                const u = child.val();
                if(u.uid !== auth.currentUser.uid && 
                   u.username && 
                   u.username.toLowerCase().includes(q)) {
                    users.push(u);
                }
            });
            
            if(users.length === 0) {
                res.innerHTML = `<p style='text-align:center; padding:20px; opacity:0.5;'>Aucun utilisateur trouv√©</p>`;
                return;
            }
            
            users.slice(0, 10).forEach(u => {
                const div = document.createElement('div');
                div.className = "friend-item";
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${u.avatar || 'Aria'}" style="width:40px; height:40px; border-radius:50%;">
                        <div>
                            <span style="font-weight:700; display:block;">@${u.username}</span>
                            <span style="font-size:10px; opacity:0.5;">Membre WhisperWave</span>
                        </div>
                    </div>
                    <button class="btn-ngl" style="width:auto; padding:8px 15px; font-size:11px;" onclick="sendFriendRequest('${u.uid}', '${(u.username || '').replace(/'/g, "\\'")}', '${u.avatar || 'Aria'}')">INVITER</button>
                `;
                res.appendChild(div);
            });
        }).catch(error => {
            console.error("Erreur de recherche:", error);
            showErrorPopin("Erreur de recherche", "Impossible de charger les utilisateurs");
        });
    };

    // --- DEMANDES D'AMIS ---

    window.sendFriendRequest = (targetUid, targetName, targetAvatar) => {
        if(!auth.currentUser || !myData) return;
        
        get(ref(db, `friends/${auth.currentUser.uid}/${targetUid}`)).then(s => {
            if(s.exists()) {
                showErrorPopin("D√©j√† amis", `Vous √™tes d√©j√† amis avec @${targetName}`);
                return;
            }
            
            set(ref(db, `friend_requests/${targetUid}/${auth.currentUser.uid}`), {
                fromId: auth.currentUser.uid,
                fromName: myData.username,
                fromAvatar: myData.avatar,
                timestamp: Date.now(),
                status: "pending"
            }).then(() => {
                showSuccessPopin("Demande envoy√©e !", `√Ä @${targetName}`);
                document.getElementById('search-input').value = "";
                setTimeout(() => {
                    toggleOverlay('search-panel', false);
                }, 1500);
            }).catch(error => {
                console.error("Erreur d'envoi de demande:", error);
                showErrorPopin("Erreur", "Impossible d'envoyer la demande");
            });
        }).catch(error => {
            console.error("Erreur de v√©rification d'amiti√©:", error);
            showErrorPopin("Erreur", "Probl√®me de connexion");
        });
    };

    function listenFriendsAndRequests() {
        onValue(ref(db, `friend_requests/${auth.currentUser.uid}`), snap => {
            const area = document.getElementById('friend-requests-area'); 
            area.innerHTML = '';
            
            if(!snap.exists()) {
                area.innerHTML = `<p style='text-align:center; padding:20px; opacity:0.5;'>Aucune demande d'ami</p>`;
                return;
            }
            
            const requests = [];
            snap.forEach(child => {
                requests.push({ id: child.key, ...child.val() });
            });
            
            if(requests.length === 0) {
                area.innerHTML = `<p style='text-align:center; padding:20px; opacity:0.5;'>Aucune demande d'ami</p>`;
                return;
            }
            
            requests.forEach(r => {
                const div = document.createElement('div');
                div.className = "friend-item";
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${r.fromAvatar || 'Aria'}" style="width:40px; height:40px; border-radius:50%;">
                        <div>
                            <span style="font-weight:800; font-size:14px;">@${r.fromName}</span>
                            <p style="font-size:10px; opacity:0.5;">Veut √™tre votre ami</p>
                        </div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-ngl" style="width:auto; padding:8px 12px; font-size:11px; background:var(--accent); color:black;" onclick="acceptFriend('${r.fromId}', '${(r.fromName || '').replace(/'/g, "\\'")}', '${r.fromAvatar || 'Aria'}')">ACCEPTER</button>
                        <button class="btn-ngl" style="width:auto; padding:8px 12px; font-size:11px; background:#ff4444; color:white;" onclick="rejectFriend('${r.fromId}')">REFUSER</button>
                    </div>
                `;
                area.appendChild(div);
            });
        });

        // √âcouter les amis pour la liste des chats
        onValue(ref(db, `friends/${auth.currentUser.uid}`), snap => {
            loadChatsList();
        });
    }

    function loadChatsList() {
        if(!auth.currentUser) return;
        
        get(ref(db, `friends/${auth.currentUser.uid}`)).then(snap => {
            const area = document.getElementById('chats-list'); 
            area.innerHTML = '';
            
            if(!snap.exists()) {
                area.innerHTML = `<p style='text-align:center; padding:40px; opacity:0.3; font-size:12px;'>Aucun ami ajout√©<br>Utilisez le bouton + pour inviter des amis</p>`;
                return;
            }
            
            const friendsList = [];
            snap.forEach(child => {
                friendsList.push({...child.val(), uid: child.key});
            });

            friendsList.sort((a, b) => (b.lastActivity || 0) - (a.lastActivity || 0));

            friendsList.forEach(f => {
                const div = document.createElement('div');
                div.className = "friend-item";
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; flex:1;">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${f.avatar || 'Aria'}" style="width:45px; height:45px; border-radius:50%;">
                        <div style="flex:1;">
                            <span style="font-weight:800; display:block;">@${f.name}</span>
                            <p style="font-size:10px; opacity:0.5;">${f.lastActivity ? 'Actif r√©cemment' : 'Jamais actif'}</p>
                        </div>
                    </div>
                    <button class="btn-ngl" style="width:auto; padding:10px 15px; font-size:11px; background:var(--primary);" onclick="openChat('${f.chatId}', '${f.uid}', '${(f.name || '').replace(/'/g, "\\'")}')">CHAT</button>
                `;
                area.appendChild(div);
            });
        }).catch(error => {
            console.error("Erreur de chargement des chats:", error);
        });
    }

    window.acceptFriend = (fromId, fromName, fromAvatar) => {
        if(!auth.currentUser || !myData) return;
        
        const chatId = [auth.currentUser.uid, fromId].sort().join('_');
        const now = Date.now();
        
        remove(ref(db, `friend_requests/${auth.currentUser.uid}/${fromId}`))
        .then(() => {
            return set(ref(db, `friends/${auth.currentUser.uid}/${fromId}`), { 
                name: fromName, 
                avatar: fromAvatar,
                chatId: chatId, 
                lastActivity: now,
                addedDate: now 
            });
        })
        .then(() => {
            return set(ref(db, `friends/${fromId}/${auth.currentUser.uid}`), { 
                name: myData.username, 
                avatar: myData.avatar,
                chatId: chatId, 
                lastActivity: now,
                addedDate: now 
            });
        })
        .then(() => {
            return set(ref(db, `messages/${chatId}/_placeholder`), {
                created: now
            }).then(() => {
                return remove(ref(db, `messages/${chatId}/_placeholder`));
            });
        })
        .then(() => {
            showSuccessPopin("Ami ajout√© !", `Vous √™tes maintenant amis avec @${fromName}`);
            toggleOverlay('notif-panel', false);
            loadChatsList(); // Recharger la liste des chats
            
            setTimeout(() => {
                openChat(chatId, fromId, fromName);
            }, 1500);
        })
        .catch(error => {
            console.error("Erreur d'acceptation d'ami:", error);
            showErrorPopin("Erreur", "Impossible d'accepter la demande");
        });
    };

    window.rejectFriend = (fromId) => {
        if(!auth.currentUser) return;
        
        remove(ref(db, `friend_requests/${auth.currentUser.uid}/${fromId}`))
            .then(() => {
                showSuccessPopin("Demande refus√©e", "La demande a √©t√© supprim√©e");
            })
            .catch(error => {
                console.error("Erreur de refus:", error);
                showErrorPopin("Erreur", "Impossible de refuser la demande");
            });
    };

    // --- SYST√àME DE CHAT ---

    window.openChat = (chatId, targetUid, targetName) => {
        if(!auth.currentUser || !myData) return;
        
        get(ref(db, `friends/${auth.currentUser.uid}/${targetUid}`)).then(snap => {
            if(!snap.exists()) {
                showErrorPopin("Non amis", "Vous devez √™tre amis pour chatter");
                return;
            }
            
            if(chatListener) {
                off(ref(db, `messages/${currentChatId}`), 'value', chatListener);
                chatListener = null;
            }
            
            currentChatId = chatId;
            currentChatTargetUid = targetUid;
            
            document.getElementById('chat-view').classList.remove('hidden');
            document.getElementById('chat-name').textContent = "@" + targetName;
            
            get(ref(db, `users/${targetUid}`)).then(s => {
                if(s.exists()) {
                    document.getElementById('chat-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${s.val().avatar}`;
                }
            });

            chatListener = snap => {
                const box = document.getElementById('chat-messages'); 
                box.innerHTML = '';
                
                if(!snap.exists()) {
                    box.innerHTML = `<p style='text-align:center; padding:40px; opacity:0.3;'>Aucun message. Commencez la conversation !</p>`;
                    return;
                }
                
                const messages = [];
                snap.forEach(c => {
                    messages.push({ id: c.key, ...c.val() });
                });
                
                messages.sort((a, b) => a.timestamp - b.timestamp);
                
                messages.forEach(m => {
                    const div = document.createElement('div');
                    div.className = `chat-bubble ${m.sender === auth.currentUser.uid ? 'sent' : 'received'}`;
                    div.textContent = m.text;
                    
                    if(m.timestamp) {
                        const time = new Date(m.timestamp);
                        const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const timeSpan = document.createElement('span');
                        timeSpan.style.cssText = 'display:block; font-size:10px; opacity:0.5; margin-top:5px; text-align:right;';
                        timeSpan.textContent = timeStr;
                        div.appendChild(timeSpan);
                    }
                    
                    box.appendChild(div);
                });
                
                box.scrollTop = box.scrollHeight;
            };
            
            onValue(ref(db, `messages/${chatId}`), chatListener);
            
        }).catch(error => {
            console.error("Erreur d'ouverture de chat:", error);
            showErrorPopin("Erreur", "Impossible d'ouvrir le chat");
        });
    };

    window.sendMessage = () => {
        if(!auth.currentUser || !myData || !currentChatId || !currentChatTargetUid) return;
        
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if(!message) return;
        
        get(ref(db, `friends/${auth.currentUser.uid}/${currentChatTargetUid}`)).then(snap => {
            if(!snap.exists()) {
                showErrorPopin("Non amis", "Vous n'√™tes plus amis");
                closeChat();
                return;
            }
            
            const now = Date.now();
            const newMessageRef = push(ref(db, `messages/${currentChatId}`));
            
            set(newMessageRef, { 
                sender: auth.currentUser.uid, 
                text: message, 
                timestamp: now,
                messageId: newMessageRef.key
            }).then(() => {
                const parts = currentChatId.split('_');
                const [uid1, uid2] = parts;
                update(ref(db, `friends/${uid1}/${uid2}`), { lastActivity: now });
                update(ref(db, `friends/${uid2}/${uid1}`), { lastActivity: now });

                input.value = "";
            }).catch(error => {
                console.error("Erreur d'envoi de message:", error);
                showErrorPopin("Erreur", "Message non envoy√©");
            });
        }).catch(error => {
            console.error("Erreur de v√©rification d'amiti√©:", error);
        });
    };

    window.handleChatKeyPress = (e) => {
        if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    };

    window.closeChat = () => {
        if(chatListener) {
            off(ref(db, `messages/${currentChatId}`), 'value', chatListener);
            chatListener = null;
        }
        currentChatId = null;
        currentChatTargetUid = null;
        document.getElementById('chat-view').classList.add('hidden');
        
        // Retourner √† la vue pr√©c√©dente
        if(currentNavView === 'chats') {
            switchToNav('chats');
        } else {
            switchToNav('inbox');
        }
    };

    // --- INITIALISATION AVATARS ---
    const grid = document.getElementById('avatar-grid');
    seeds.forEach(s => {
        const img = document.createElement('img');
        img.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${s}`;
        img.style = "width:100%; border-radius:50%; cursor:pointer; background:#222; padding:5px;";
        img.onclick = () => {
            Array.from(grid.children).forEach(c => c.style.border = "none");
            img.style.border = "2px solid var(--primary)";
            selectedAvatar = s;
        };
        grid.appendChild(img);
    });
    
    if (grid.firstChild) {
        setTimeout(() => grid.firstChild.click(), 100);
    }

    // --- MESSAGES ANONYMES ---

    function loadInbox(uid) {
        onValue(ref(db, `ngl_messages/${uid}`), snap => {
            const cont = document.getElementById('msg-container'); 
            cont.innerHTML = '';
            
            if(!snap.exists()) { 
                cont.innerHTML = `<p style='text-align:center; opacity:0.3; padding:40px; font-size:12px;'>Aucun message secret re√ßu</p>`; 
                updateMessageCountBadge(0);
                return; 
            }
            
            const messages = [];
            let unreadCount = 0;
            snap.forEach(m => {
                const msg = m.val();
                messages.push({ id: m.key, ...msg });
                if(!msg.read) unreadCount++;
            });
            
            updateMessageCountBadge(messages.length);
            unreadMessagesCount = unreadCount;
            
            const totalNotifications = unreadFriendRequestsCount + unreadMessagesCount;
            updateNotificationBadge(totalNotifications);
            
            messages.sort((a, b) => b.time - a.time);
            
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = "msg-bubble";
                const date = new Date(msg.time);
                const dateStr = `${date.toLocaleDateString()} √† ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                
                const escapedText = msg.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="width:8px; height:8px; border-radius:50%; background:${msg.read ? 'transparent' : 'var(--primary)'};"></div>
                            <span style="font-size:10px; opacity:0.5;">${dateStr}</span>
                        </div>
                    </div>
                    <div class="message-preview" onclick="showMessagePopin('${msg.text.replace(/'/g, "\\'").replace(/\n/g, '<br>')}'); markMessageAsRead('${msg.id}')">
                        ${escapedText}
                        ${msg.text.length > 150 ? '<span class="read-more">... lire plus</span>' : ''}
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:10px; opacity:0.5;">Message anonyme</span>
                        <button class="btn-ngl" style="padding:10px; font-size:11px; background:var(--primary); color:white;" onclick="downloadMsg('${msg.text.replace(/'/g, "\\'")}')">CAPTURE üì∏</button>
                    </div>
                `;
                cont.appendChild(div);
            });
        });
    }

    window.markMessageAsRead = (messageId) => {
        if(!auth.currentUser) return;
        
        update(ref(db, `ngl_messages/${auth.currentUser.uid}/${messageId}`), {
            read: true
        }).then(() => {
            const messageDiv = document.querySelector(`[onclick*="${messageId}"]`);
            if(messageDiv) {
                const dot = messageDiv.parentElement.querySelector('div[style*="width:8px"]');
                if(dot) dot.style.background = 'transparent';
            }
        }).catch(error => {
            console.error("Erreur de marquage comme lu:", error);
        });
    };

    function updateMessageCountBadge(count) {
        const badge = document.getElementById('message-count-badge');
        if(count > 0) {
            badge.style.display = 'inline';
            badge.textContent = count > 99 ? '99+' : count;
        } else {
            badge.style.display = 'none';
        }
    }

    window.sendMsg = () => {
        const t = document.getElementById('msg-text').value.trim();
        const uId = new URLSearchParams(window.location.search).get('u');
        
        if(!t) {
            showErrorPopin("Message vide", "√âcrivez quelque chose");
            return;
        }
        
        if(!uId) {
            showErrorPopin("Destinataire invalide", "Lien corrompu");
            return;
        }
        
        push(ref(db, `ngl_messages/${uId}`), { 
            text: t, 
            time: Date.now(),
            read: false
        }).then(() => {
            showSuccessPopin("Secret envoy√© !", "Votre message a √©t√© d√©livr√©");
            document.getElementById('msg-text').value = "";
            setTimeout(() => {
                window.location.href = "index.html";
            }, 2000);
        }).catch(error => {
            console.error("Erreur d'envoi:", error);
            showErrorPopin("Erreur d'envoi", "V√©rifiez votre connexion");
        });
    };

    window.sendRandomMsg = () => {
        const text = document.getElementById('random-msg-text').value.trim();
        
        if(!text) {
            showErrorPopin("Message vide", "√âcrivez quelque chose");
            return;
        }
        
        if(!auth.currentUser) {
            showErrorPopin("Non connect√©", "Connectez-vous d'abord");
            switchView('login');
            return;
        }
        
        get(ref(db, 'users')).then(snap => {
            const users = []; 
            snap.forEach(u => { 
                if(u.key !== auth.currentUser.uid) users.push(u.key); 
            });
            
            if(users.length === 0) {
                showErrorPopin("Pas d'utilisateurs", "Attendez que d'autres s'inscrivent");
                return;
            }
            
            const luckyOne = users[Math.floor(Math.random() * users.length)];
            
            push(ref(db, `ngl_messages/${luckyOne}`), { 
                text: "[üé≤ D√©lirium] " + text, 
                time: Date.now(),
                fromRandom: true,
                read: false
            }).then(() => {
                showSuccessPopin("Message propuls√© !", "Vers un inconnu...");
                document.getElementById('random-msg-text').value = "";
                setTimeout(() => {
                    switchToNav('inbox');
                }, 1500);
            }).catch(error => {
                console.error("Erreur d'envoi al√©atoire:", error);
                showErrorPopin("Erreur", "Message non envoy√©");
            });
        }).catch(error => {
            console.error("Erreur de r√©cup√©ration des utilisateurs:", error);
            showErrorPopin("Erreur", "Impossible de trouver des utilisateurs");
        });
    };

    window.deleteAllMessages = () => {
        if(confirm("Voulez-vous vraiment effacer tout votre historique de messages anonymes ? Cette action est irr√©versible.")) {
            remove(ref(db, `ngl_messages/${auth.currentUser.uid}`)).then(() => {
                toggleOverlay('settings-panel', false);
                showSuccessPopin("Historique effac√©", "Tous les messages ont √©t√© supprim√©s");
            }).catch(error => {
                console.error("Erreur de suppression:", error);
                showErrorPopin("Erreur", "Impossible de supprimer");
            });
        }
    };

    window.copyLink = () => {
        if(!auth.currentUser) {
            showErrorPopin("Non connect√©", "Connectez-vous d'abord");
            return;
        }
        
        const l = window.location.origin + window.location.pathname + "?u=" + auth.currentUser.uid;
        navigator.clipboard.writeText(l).then(() => {
            showSuccessPopin("Lien copi√© !", "Partagez-le maintenant");
        }).catch(() => {
            const textArea = document.createElement("textarea");
            textArea.value = l;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);
            showSuccessPopin("Lien copi√© !", "Partagez-le maintenant");
        });
    };

    window.shareTo = (p) => {
        if(!auth.currentUser) {
            showErrorPopin("Non connect√©", "Connectez-vous d'abord");
            return;
        }
        
        const link = window.location.origin + window.location.pathname + "?u=" + auth.currentUser.uid;
        const text = encodeURIComponent("Envoie-moi des messages anonymes sur WhisperWave ! ü§´\n" + link);
        
        switch(p) {
            case 'whatsapp':
                window.open(`https://wa.me/?text=${text}`);
                break;
            case 'facebook':
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`);
                break;
            case 'snapchat':
                navigator.clipboard.writeText(link).then(() => {
                    showSuccessPopin("Lien copi√© !", "Collez-le dans Snapchat");
                });
                break;
        }
    };

    window.downloadMsg = (text) => {
        const zone = document.getElementById('capture-zone');
        document.getElementById('capture-text').textContent = text;
        zone.style.backgroundColor = getComputedStyle(document.body).getPropertyValue('--primary');
        
        html2canvas(zone).then(canvas => {
            const link = document.createElement('a');
            link.download = `WhisperSecret_${Date.now()}.png`;
            link.href = canvas.toDataURL(); 
            link.click();
            showSuccessPopin("Capture r√©ussie !", "Image t√©l√©charg√©e");
        }).catch(error => {
            console.error("Erreur de capture:", error);
            showErrorPopin("Erreur", "Capture impossible");
        });
    };

    window.setTheme = (t, el) => {
        document.body.classList.remove('theme-royal', 'theme-sunset', 'theme-emerald');
        if(t !== 'default') document.body.classList.add('theme-' + t);
        document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
        el.classList.add('active');
        localStorage.setItem('ww-theme', t);
    };

    window.login = () => {
        const email = document.getElementById('l-email').value.trim();
        const password = document.getElementById('l-pass').value;
        
        if(!email || !password) {
            showErrorPopin("Champs vides", "Remplissez tous les champs");
            return;
        }
        
        signInWithEmailAndPassword(auth, email, password)
            .then(() => {
                // Connexion r√©ussie
            })
            .catch(error => {
                console.error("Erreur de connexion:", error);
                if(error.code === 'auth/user-not-found') {
                    showErrorPopin("Utilisateur non trouv√©", "V√©rifiez votre email");
                } else if(error.code === 'auth/wrong-password') {
                    showErrorPopin("Mot de passe incorrect", "R√©essayez");
                } else if(error.code === 'auth/invalid-email') {
                    showErrorPopin("Email invalide", "Format incorrect");
                } else {
                    showErrorPopin("Erreur de connexion", "V√©rifiez vos identifiants");
                }
            });
    };
    
    window.register = () => {
        const username = document.getElementById('r-user').value.trim();
        const email = document.getElementById('r-email').value.trim();
        const password = document.getElementById('r-pass').value;
        
        if(!username || !email || !password) {
            showErrorPopin("Champs vides", "Remplissez tous les champs");
            return;
        }
        
        if(username.length < 3) {
            showErrorPopin("Pseudo trop court", "Minimum 3 caract√®res");
            return;
        }
        
        if(password.length < 6) {
            showErrorPopin("Mot de passe faible", "Minimum 6 caract√®res");
            return;
        }
        
        createUserWithEmailAndPassword(auth, email, password)
            .then(r => {
                return set(ref(db, `users/${r.user.uid}`), { 
                    username: username, 
                    avatar: selectedAvatar, 
                    uid: r.user.uid,
                    createdAt: Date.now(),
                    email: email
                });
            })
            .then(() => {
                showSuccessPopin("Compte cr√©√© !", `Bienvenue @${username}`);
            })
            .catch(error => {
                console.error("Erreur d'inscription:", error);
                if(error.code === 'auth/email-already-in-use') {
                    showErrorPopin("Email d√©j√† utilis√©", "Utilisez un autre email");
                } else if(error.code === 'auth/weak-password') {
                    showErrorPopin("Mot de passe faible", "Trop simple");
                } else {
                    showErrorPopin("Erreur d'inscription", "R√©essayez");
                }
            });
    };
    
    window.logout = () => {
        signOut(auth).then(() => {
            location.reload();
        }).catch(error => {
            console.error("Erreur de d√©connexion:", error);
            showErrorPopin("Erreur", "D√©connexion impossible");
        });
    };

    // Initialisation du th√®me
    document.addEventListener('DOMContentLoaded', function() {
        const savedTheme = localStorage.getItem('ww-theme') || 'default';
        const isDarkMode = localStorage.getItem('ww-dark-mode') !== 'false';
        
        document.getElementById('dark-mode-toggle').checked = isDarkMode;
        toggleDarkMode(isDarkMode);
        
        if(savedTheme !== 'default') {
            document.body.classList.add('theme-' + savedTheme);
        }
        
        const themeDots = document.querySelectorAll('.theme-dot');
        if(themeDots.length > 0) {
            const themeIndex = {
                'default': 0,
                'royal': 1,
                'sunset': 2,
                'emerald': 3
            };
            const index = themeIndex[savedTheme] || 0;
            themeDots[index].classList.add('active');
        }
        
        document.addEventListener('keydown', function(e) {
            if(e.key === 'Escape') {
                document.querySelectorAll('.overlay.active').forEach(overlay => {
                    overlay.classList.remove('active');
                });
                closeChat();
                hideMessagePopin();
                hidePopin();
            }
        });
    });
</script>
</body>
</html>

